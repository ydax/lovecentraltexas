steps:
  # Install dependencies for the entire workspace
  - name: 'node:20'
    entrypoint: yarn
    args: ['install', '--frozen-lockfile']
    id: 'install-dependencies'

  # Build quin (Cloud Functions)
  - name: 'node:20'
    entrypoint: yarn
    args: ['workspace', 'quin', 'build']
    id: 'build-quin'
    waitFor: ['install-dependencies']

  # Build the app (NextJS)
  - name: 'node:20'
    entrypoint: yarn
    args: ['workspace', 'app', 'build']
    id: 'build-app'
    waitFor: ['install-dependencies']

  # Deploy Firestore rules and indexes
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: bash
    args:
      - '-c'
      - |
        curl -sL https://firebase.tools | bash
        firebase deploy --only firestore --project lovecentraltexas --non-interactive
    id: 'deploy-firestore'
    waitFor: ['install-dependencies']

  # Deploy Cloud Functions (quin)
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: bash
    args:
      - '-c'
      - |
        curl -sL https://firebase.tools | bash
        firebase deploy --only functions --project lovecentraltexas --non-interactive
    id: 'deploy-functions'
    waitFor: ['build-quin']
    secretEnv: ['GEMINI_API_KEY']

  # Deploy Hosting (app)
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: bash
    args:
      - '-c'
      - |
        curl -sL https://firebase.tools | bash
        firebase deploy --only hosting --project lovecentraltexas --non-interactive
    id: 'deploy-hosting'
    waitFor: ['build-app']

# Secret configuration for Gemini API key
availableSecrets:
  secretManager:
    - versionName: projects/956360338882/secrets/GEMINI_API_KEY/versions/latest
      env: 'GEMINI_API_KEY'

# Build timeout
timeout: '1800s'

# Build options
options:
  machineType: 'E2_HIGHCPU_8'
  logging: CLOUD_LOGGING_ONLY

